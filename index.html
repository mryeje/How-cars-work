<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>How Cars Work</title>
<style>
  :root { 
    --bg: #FDFBF7;
    --surface: #ffffff;
    --text: #1a1a1a;
    --text-muted: #555555;
    --accent: #2563eb;
    --accent-light: #dbeafe;
    --success: #166534;
    --success-bg: #dcfce7;
    --border: #e5e7eb;
    --font-main: "Verdana", "Segoe UI", sans-serif;
  }

  body {
    margin: 0;
    background-color: var(--bg);
    color: var(--text);
    font-family: var(--font-main);
    font-size: 20px;
    line-height: 1.6;
  }

  header {
    background: var(--surface);
    border-bottom: 2px solid var(--border);
    padding: 20px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
  }

  .header-content {
    max-width: 900px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  h1 { margin: 0; font-size: 1.2rem; color: var(--accent); }
  .subtitle { font-size: 0.9rem; color: var(--text-muted); font-weight: normal; }

  .container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 40px;
  }

  .mobile-menu-btn {
    display: none;
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--accent);
    color: white;
    border: none;
    width: 70px;
    height: 70px;
    border-radius: 50%;
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 200;
    font-weight: bold;
  }

  .mobile-menu-btn:active {
    transform: scale(0.95);
  }

  .sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 500;
  }

  .sidebar-overlay.active {
    display: block;
  }

  .mobile-close-btn {
    display: none;
    position: sticky;
    top: 10px;
    background: #ef4444;
    color: white;
    border: none;
    padding: 15px 25px;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: bold;
    cursor: pointer;
    margin-bottom: 15px;
    width: 100%;
  }

  @media (max-width: 800px) {
    .container { grid-template-columns: 1fr; }
    
    .sidebar { 
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 600;
      max-height: 100vh;
      border-radius: 0;
      padding: 20px;
      overflow-y: auto;
    }

    .sidebar.mobile-open {
      display: block;
    }

    .mobile-menu-btn {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mobile-close-btn {
      display: block;
    }

    .header-content {
      flex-direction: column;
      gap: 15px;
    }
    .header-actions {
      flex-direction: column;
      width: 100%;
    }
    .book-btn, .help-btn {
      width: 100%;
      justify-content: center;
    }

    .timer-widget {
      width: 100%;
      justify-content: center;
    }
  }

  .sidebar {
    background: var(--surface);
    padding: 20px;
    border-radius: 12px;
    border: 1px solid var(--border);
    height: fit-content;
    max-height: 80vh;
    overflow-y: auto;
  }

  .progress-widget {
    background: var(--success-bg);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 2px solid var(--success);
  }

  .progress-widget h3 {
    margin: 0 0 10px 0;
    font-size: 1rem;
    color: var(--success);
  }

  .progress-bar-container {
    background: #fff;
    border-radius: 10px;
    height: 30px;
    overflow: hidden;
    margin: 10px 0;
  }

  .progress-bar {
    background: var(--success);
    height: 100%;
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 0.9rem;
  }

  .progress-text {
    font-size: 0.95rem;
    color: var(--text);
    margin-top: 8px;
  }

  .nav-chapter {
    font-weight: bold;
    margin-top: 15px;
    margin-bottom: 8px;
    color: var(--text-muted);
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .nav-item {
    display: flex;
    justify-content: space-between;
    padding: 12px 10px;
    cursor: pointer;
    border-radius: 8px;
    margin-bottom: 4px;
    border: 1px solid transparent;
  }

  .nav-item:hover { background-color: var(--bg); }
   
  .nav-item.active { 
    background-color: var(--accent-light); 
    color: var(--accent); 
    font-weight: bold;
    border-color: var(--accent);
  }

  .nav-item.done .status { color: var(--success); font-size: 1.2rem; }

  .lesson-card {
    background: var(--surface);
    padding: 40px;
    border-radius: 12px;
    border: 1px solid var(--border);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
  }

  .welcome-box {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
  }

  .welcome-box h2 {
    margin-top: 0;
    font-size: 1.8rem;
  }

  .how-it-works {
    background: #f8fafc;
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
  }

  .how-it-works h3 {
    color: var(--accent);
    margin-top: 0;
    font-size: 1.3rem;
  }

  .step-box {
    background: white;
    border-left: 4px solid var(--accent);
    padding: 15px 20px;
    margin: 15px 0;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  .step-box strong {
    color: var(--accent);
    font-size: 1.1rem;
  }

  .lesson-meta {
    font-size: 0.9rem;
    color: var(--text-muted);
    background: #f3f4f6;
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    margin-bottom: 15px;
  }

  h2 { font-size: 2rem; margin-top: 0; color: #111; }
   
  .book-reference {
    background: #fffbeb;
    border-left: 5px solid #f59e0b;
    padding: 15px;
    margin: 20px 0;
    font-size: 1.1rem;
  }

  .content-text {
    font-size: 1.1rem;
    margin-bottom: 30px;
  }

  .analogy-box {
    background: var(--accent-light);
    border: 1px solid #bfdbfe;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px;
  }
  .analogy-box h3 { margin-top: 0; color: var(--accent); font-size: 1.1rem; }

  .recall-box {
    border: 2px dashed #b91c1c;
    background: #fef2f2;
    padding: 20px;
    border-radius: 8px;
    margin: 30px 0;
    text-align: center;
    font-weight: bold;
  }

  .quiz-box {
    margin-top: 40px;
    border-top: 2px solid var(--border);
    padding-top: 20px;
  }

  .option {
    display: block;
    width: 100%;
    text-align: left;
    background: var(--bg);
    border: 2px solid var(--border);
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.05rem;
    font-family: var(--font-main);
  }
  .option:hover { border-color: var(--text-muted); }
  .option.correct { background: var(--success-bg); border-color: var(--success); }
  .option.incorrect { background: #fef2f2; border-color: #ef4444; }

  .feedback { margin-top: 15px; font-weight: bold; display: none; padding: 10px; border-radius: 4px; }

  .controls {
    display: flex;
    justify-content: space-between;
    margin-top: 40px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
  }

  button.btn {
    background: var(--accent);
    color: white;
    border: none;
    padding: 15px 30px;
    font-size: 1.1rem;
    border-radius: 50px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 10px;
  }
   
  button.btn:hover { background: #1d4ed8; }
  button.btn-secondary { background: white; color: var(--text); border: 2px solid var(--border); }
  button.btn-secondary:hover { background: var(--bg); }

  .timer-widget {
    background: #111;
    color: #fff;
    padding: 8px 16px;
    border-radius: 50px;
    font-family: monospace;
    font-size: 1.2rem;
    display: flex;
    gap: 10px;
    align-items: center;
  }
  .timer-btn {
    background: #333; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;
  }

  .book-btn, .help-btn {
    background: var(--accent);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.2s;
  }
  .book-btn:hover, .help-btn:hover {
    background: #1d4ed8;
  }
  .help-btn {
    background: #10b981;
  }
  .help-btn:hover {
    background: #059669;
  }
  .header-actions {
    display: flex;
    gap: 15px;
    align-items: center;
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
  }

  .modal-content {
    background-color: var(--surface);
    margin: 5% auto;
    padding: 30px;
    border-radius: 12px;
    width: 90%;
    max-width: 700px;
    max-height: 80vh;
    overflow-y: auto;
  }

  .close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }

  .close:hover {
    color: #000;
  }

  .tip-icon {
    display: inline-block;
    background: #fbbf24;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    text-align: center;
    line-height: 24px;
    font-weight: bold;
    margin-right: 8px;
  }
</style>
</head>
<body>

<header>
  <div class="header-content">
    <div>
      <h1>How Cars Work</h1>
      <span class="subtitle">Interactive Learning Course</span>
    </div>
    <div class="header-actions">
      <button class="help-btn" onclick="showHowItWorks()">
        ‚ùì How This Works
      </button>
      <button class="book-btn" onclick="openTextbook()">
        üìñ Open Textbook
      </button>
      <div class="timer-widget">
        <span id="timerDisplay">25:00</span>
        <button class="timer-btn" onclick="toggleTimer()">Start Work</button>
      </div>
    </div>
  </div>
</header>

<div class="container">
  <div class="sidebar" id="sidebar"></div>

  <main>
    <div id="lessonContainer" class="lesson-card"></div>

    <div class="controls" id="lessonControls" style="display:none">
      <button class="btn btn-secondary" onclick="prevLesson()">‚Üê Back</button>
      <div style="text-align:right">
        <label style="display:block; margin-bottom:10px; font-size:0.9rem;">
          <input type="checkbox" id="markDone" onchange="toggleDone()" style="transform: scale(1.5); margin-right: 10px;"> 
          I finished this lesson
        </label>
        <button class="btn" onclick="nextLesson()">Next Lesson ‚Üí</button>
      </div>
    </div>
  </main>
</div>

<!-- Mobile Menu Button -->
<button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Open Menu">
  üìö<br><span style="font-size: 0.5em;">Menu</span>
</button>

<!-- Sidebar Overlay for Mobile -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobileMenu()"></div>

<!-- Modal continues in next message due to length -->

<!-- How It Works Modal -->
<div id="howItWorksModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeHowItWorks()">&times;</span>
    <h2 style="color: var(--accent); margin-top: 0;">How This Course Works</h2>
    
    <p style="font-size: 1.1rem; line-height: 1.7;">
      Welcome! This course is designed to help you learn about cars at your own pace. There's no rush, and you can't make mistakes. Here's how to get the most out of your learning:
    </p>

    <div class="step-box">
      <strong>1. Work in Short Sessions</strong>
      <p>Each time you sit down to learn, start the 25-minute timer at the top of the page. This keeps your learning session focused without feeling too long. When the timer ends, take a break! Stand up, stretch, get a drink. Your brain learns better with regular breaks.</p>
    </div>

    <div class="step-box">
      <strong>2. Read Small Chunks</strong>
      <p>Each lesson is short and focuses on just one idea. This makes it easier to understand and remember. Don't try to do too many lessons at once‚Äîone or two per session is perfect.</p>
    </div>

    <div class="step-box">
      <strong>3. Look at the Book</strong>
      <p>When the lesson tells you to look at the book, take your time with the diagram. The picture and the text work together to help you understand.</p>
    </div>

    <div class="step-box">
      <strong>4. Test Yourself (The "STOP" Box)</strong>
      <p>When you see the red "STOP" box, look away from the screen and try to explain the main idea out loud‚Äîlike you're teaching it to someone. This simple step helps your brain remember it tomorrow!</p>
    </div>

    <div class="step-box">
      <strong>5. Practice Questions</strong>
      <p>After each lesson, you'll answer a few simple questions. These aren't tests‚Äîthey're just practice to help lock in what you learned. If you get one wrong, that's okay! You can try again.</p>
    </div>

    <div class="step-box">
      <strong>6. Check Your Progress</strong>
      <p>The green box on the left shows how many lessons you've completed. Check the "I finished this lesson" box when you're done, and your progress is saved automatically. You can always come back and continue where you left off.</p>
    </div>

    <div class="step-box">
      <strong>7. Come Back Regularly</strong>
      <p>Learning works best when you spread it out. Try to do one or two lessons every few days rather than many at once. Your brain builds stronger memories this way.</p>
    </div>

    <p style="margin-top: 25px; padding: 15px; background: var(--success-bg); border-radius: 8px; border-left: 4px solid var(--success);">
      <strong>Remember:</strong> Take your time. There's no deadline. Everyone learns at their own speed, and that's perfectly fine. If something doesn't make sense, review it again or skip it and come back later.
    </p>

    <button class="btn" onclick="closeHowItWorks()" style="margin-top: 20px; width: 100%; justify-content: center;">
      Got It! Let's Start Learning
    </button>
  </div>
</div>

<script>
let courseData = [];

async function loadCourse() {
  const base = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);

  console.log('Loading course from base URL:', base);
  
  const manifestResp = await fetch(base + "data/manifest.json");
  if (!manifestResp.ok) throw new Error("Missing data/manifest.json (HTTP " + manifestResp.status + ")");
  
  console.log('Manifest loaded successfully');
  const manifest = await manifestResp.json();
  console.log('Manifest parsed:', manifest);

  const chapterFiles = manifest.chapters.map(c => base + "data/" + c.file);
  console.log('Loading chapter files:', chapterFiles);

  const chapters = await Promise.all(
    chapterFiles.map(async (url) => {
      console.log('Fetching:', url);
      const r = await fetch(url);
      if (!r.ok) throw new Error("Missing chapter file: " + url + " (HTTP " + r.status + ")");
      const data = await r.json();
      console.log('Loaded chapter:', data.chapter);
      return data;
    })
  );

  courseData = chapters.flatMap(ch =>
    (ch.lessons || []).map(L => ({
      ...L,
      chapter: ch.chapter
    }))
  );
  
  console.log('Course data loaded. Total lessons:', courseData.length);
}

let currentLessonIndex = 0;
let doneLessons = JSON.parse(localStorage.getItem('carCourse_done')) || [];
let firstVisit = !localStorage.getItem('carCourse_visited');

function init() {
  if (!courseData || courseData.length === 0) {
    document.getElementById('lessonContainer').innerHTML = `
      <h2>‚ö†Ô∏è No lessons found</h2>
      <p>manifest.json loaded, but no lessons were found in the chapter files.</p>
    `;
    return;
  }

  renderSidebar();

  const savedIndexRaw = localStorage.getItem('carCourse_lastIndex');
  const savedIndex = savedIndexRaw ? parseInt(savedIndexRaw, 10) : 0;

  if (firstVisit) {
    localStorage.setItem('carCourse_visited', 'true');
    showWelcome();
  } else if (Number.isFinite(savedIndex) && savedIndex >= 0 && savedIndex < courseData.length) {
    loadLesson(savedIndex);
  } else {
    loadLesson(0);
  }
}

async function startApp() {
  try {
    await loadCourse();
    init();
    checkPdfAvailability();
  } catch (err) {
    console.error("Course failed to load:", err);
    const errorDetails = err.message || String(err);
    document.getElementById('lessonContainer').innerHTML = `
      <h2>‚ö†Ô∏è Course Load Error</h2>
      <p style="color: #d32f2f; font-weight: bold;">${errorDetails}</p>
      <h3>Troubleshooting steps:</h3>
      <ol>
        <li>Check that <code>data/manifest.json</code> exists</li>
        <li>Verify all chapter JSON files referenced in manifest.json exist in the <code>data/</code> folder</li>
        <li>File names are case-sensitive (chapter1.json ‚â† Chapter1.json)</li>
        <li>Make sure all JSON files are valid (no trailing commas, proper quotes)</li>
        <li>Check the browser console (F12) for more detailed errors</li>
      </ol>
      <p><strong>Current location:</strong> ${window.location.href}</p>
    `;
  }
}

async function checkPdfAvailability() {
  console.log('üìñ Textbook hosted on Google Drive');
}

startApp();

function showWelcome() {
  const container = document.getElementById('lessonContainer');
  const controls = document.getElementById('lessonControls');
  controls.style.display = 'none';
  
  container.innerHTML = `
    <div class="welcome-box">
      <h2>Welcome to How Cars Work!</h2>
      <p style="font-size: 1.1rem; margin-bottom: 0;">
        You're about to learn how cars work, one simple lesson at a time. This course is designed for you to learn comfortably at your own pace.
      </p>
    </div>

    <div class="how-it-works">
      <h3>üìö How This Course Works</h3>
      
      <div class="step-box">
        <strong>Step 1: Start Your Timer</strong>
        <p>See the timer at the top of the page? When you begin learning, click "Start Work". It will count down from 25 minutes. This helps you stay focused for a short, manageable time. When it's done, take a break!</p>
      </div>

      <div class="step-box">
        <strong>Step 2: Read One Lesson</strong>
        <p>Each lesson is short and teaches just one thing. Read it carefully. Don't worry about finishing everything today‚Äîone lesson at a time is perfect.</p>
      </div>

      <div class="step-box">
        <strong>Step 3: Look at the Book</strong>
        <p>When the lesson mentions the textbook, click "üìñ Open Textbook" at the top and look at the page. The pictures help you understand better.</p>
      </div>

      <div class="step-box">
        <strong>Step 4: Explain It to Yourself</strong>
        <p>When you see a red "STOP!" box, look away and try to say the main idea out loud. This simple trick helps your brain remember!</p>
      </div>

      <div class="step-box">
        <strong>Step 5: Answer Practice Questions</strong>
        <p>At the end of each lesson, you'll answer a few questions. These help you practice. If you get something wrong, you can try again‚Äîno pressure!</p>
      </div>

      <div class="step-box">
        <strong>Step 6: Check the Box</strong>
        <p>When you finish a lesson, check the "I finished this lesson" box. Your progress saves automatically so you can continue anytime.</p>
      </div>

      <p style="margin-top: 25px; padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
        <span class="tip-icon">üí°</span>
        <strong>Best Learning Tip:</strong> Do one or two lessons, then come back in a day or two. Spreading out your learning helps you remember better than trying to do everything at once!
      </p>
    </div>

    <button class="btn" onclick="loadLesson(0)" style="width: 100%; justify-content: center; font-size: 1.2rem; padding: 20px;">
      Start Lesson 1 ‚Üí
    </button>

    <p style="text-align: center; margin-top: 15px; color: var(--text-muted);">
      <small>You can review these tips anytime by clicking "‚ùì How This Works" at the top</small>
    </p>
  `;
}

function showHowItWorks() {
  document.getElementById('howItWorksModal').style.display = 'block';
}

function closeHowItWorks() {
  document.getElementById('howItWorksModal').style.display = 'none';
}

window.onclick = function(event) {
  const modal = document.getElementById('howItWorksModal');
  if (event.target == modal) {
    closeHowItWorks();
  }
  // Note: sidebar overlay handled by its own onclick
}

function renderSidebar() {
  const sidebar = document.getElementById('sidebar');
  const totalLessons = courseData.length;
  const completedLessons = doneLessons.length;
  const progressPercent = totalLessons > 0 ? Math.round((completedLessons / totalLessons) * 100) : 0;
  
  sidebar.innerHTML = `
    <button class="mobile-close-btn" onclick="closeMobileMenu()">‚úï Close Menu</button>
    
    <div class="progress-widget">
      <h3>Your Progress</h3>
      <div class="progress-bar-container">
        <div class="progress-bar" style="width: ${progressPercent}%">
          ${progressPercent}%
        </div>
      </div>
      <div class="progress-text">
        ${completedLessons} of ${totalLessons} lessons completed
      </div>
    </div>
  `;

  let currentChapter = "";

  courseData.forEach((lesson, index) => {
    if (lesson.chapter !== currentChapter) {
      const chapHeader = document.createElement('div');
      chapHeader.className = "nav-chapter";
      chapHeader.textContent = lesson.chapter;
      sidebar.appendChild(chapHeader);
      currentChapter = lesson.chapter;
    }

    const item = document.createElement('div');
    item.className = `nav-item ${index === currentLessonIndex ? 'active' : ''} ${doneLessons.includes(lesson.id) ? 'done' : ''}`;
    item.onclick = () => {
      loadLesson(index);
      closeMobileMenu();
    };
    item.innerHTML = `
      <span>${lesson.title}</span>
      <span class="status">${doneLessons.includes(lesson.id) ? '‚úì' : ''}</span>
    `;
    sidebar.appendChild(item);
  });
}

function loadLesson(index) {
  if (!courseData || courseData.length === 0) return;
  if (index < 0 || index >= courseData.length) index = 0;

  currentLessonIndex = index;
  localStorage.setItem('carCourse_lastIndex', index);

  const lesson = courseData[index];
  if (!lesson) return;

  const container = document.getElementById('lessonContainer');
  const controls = document.getElementById('lessonControls');
  const checkbox = document.getElementById('markDone');

  controls.style.display = 'flex';
  checkbox.checked = doneLessons.includes(lesson.id);

  let quizHTML = "";
  if (lesson.quiz) {
    const safeFeedback = String(lesson.quiz.feedback || "").replace(/'/g, "\\'");
    quizHTML = `
      <div class="quiz-box">
        <h3>Quick Practice:</h3>
        <p>${lesson.quiz.question}</p>
        <div id="quizOptions">
          ${(lesson.quiz.options || []).map((opt, i) =>
            `<button class="option" onclick="checkAnswer(this, ${i}, ${lesson.quiz.answer}, '${safeFeedback}')">${opt}</button>`
          ).join('')}
        </div>
        <div id="quizFeedback" class="feedback"></div>
      </div>
    `;
  }

  let analogyHTML = "";
  if (lesson.analogy) {
    analogyHTML = `
      <div class="analogy-box">
        <h3>üí° Plain English Explanation</h3>
        <p>${lesson.analogy}</p>
      </div>
    `;
  }

  container.innerHTML = `
    <div class="lesson-meta">Page ${lesson.page ?? ""} ‚Ä¢ ${lesson.chapter}</div>
    <h2>${lesson.title}</h2>

    ${analogyHTML}

    <div class="book-reference">
      <strong>üìñ Book Reading:</strong><br>
      Please turn to <strong>Page ${lesson.page ?? ""}</strong> in the book.<br>
      <em>Look at the diagram while you read the text below.</em>
    </div>

    <div class="content-text">
      ${lesson.text || ""}
    </div>

    <div class="recall-box">
      üõë STOP! <br>
      Look away from the screen.<br>
      Can you explain the main idea out loud in one sentence?<br>
      <em>(This step helps you remember it tomorrow!)</em>
    </div>

    ${quizHTML}
  `;

  renderSidebar();
  window.scrollTo(0,0);
}

function checkAnswer(btnElement, choiceIndex, correctIndex, feedbackText) {
  const parent = document.getElementById('quizOptions');
  const feedbackEl = document.getElementById('quizFeedback');
  if (!parent || !feedbackEl) return;

  Array.from(parent.children).forEach(btn => {
    btn.classList.remove('correct', 'incorrect');
    btn.disabled = true;
  });

  if (choiceIndex === correctIndex) {
    btnElement.classList.add('correct');
    feedbackEl.style.backgroundColor = "var(--success-bg)";
    feedbackEl.style.color = "var(--success)";
    feedbackEl.textContent = "‚úÖ " + feedbackText;
  } else {
    btnElement.classList.add('incorrect');
    feedbackEl.style.backgroundColor = "#fef2f2";
    feedbackEl.style.color = "#d32f2f";
    feedbackEl.textContent = "Not quite. Reread the 'Plain English Explanation' above and try again!";
    Array.from(parent.children).forEach(btn => btn.disabled = false);
  }

  feedbackEl.style.display = "block";
}

function nextLesson() {
  if (currentLessonIndex < courseData.length - 1) {
    loadLesson(currentLessonIndex + 1);
  }
}

function prevLesson() {
  if (currentLessonIndex > 0) {
    loadLesson(currentLessonIndex - 1);
  }
}

function toggleDone() {
  const lesson = courseData[currentLessonIndex];
  const checkbox = document.getElementById('markDone');
  if (!lesson || !checkbox) return;

  if (checkbox.checked) {
    if (!doneLessons.includes(lesson.id)) doneLessons.push(lesson.id);
  } else {
    doneLessons = doneLessons.filter(id => id !== lesson.id);
  }

  localStorage.setItem('carCourse_done', JSON.stringify(doneLessons));
  renderSidebar();
}

let timerInterval;
let timeLeft = 25 * 60;
let isTimerRunning = false;

function toggleTimer() {
  const display = document.getElementById('timerDisplay');
  const btn = document.querySelector('.timer-btn');

  if (isTimerRunning) {
    clearInterval(timerInterval);
    isTimerRunning = false;
    btn.textContent = "Start Work";
    return;
  }

  isTimerRunning = true;
  btn.textContent = "Pause";

  timerInterval = setInterval(() => {
    timeLeft--;

    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      alert("Great work! Time for a break. Stand up, stretch, and rest your eyes. Come back when you're ready for the next session.");
      isTimerRunning = false;
      timeLeft = 25 * 60;
      display.textContent = "25:00";
      btn.textContent = "Start Work";
      return;
    }

    const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
    const s = (timeLeft % 60).toString().padStart(2, '0');
    display.textContent = `${m}:${s}`;
  }, 1000);
}

function openTextbook() {
  const pdfUrl = 'https://drive.google.com/file/d/1mDLl94WcQqHQB2uHXBu5PDiww0MkUElN/preview';
  
  console.log('Opening textbook from Google Drive:', pdfUrl);
  window.open(pdfUrl, '_blank');
}

function toggleMobileMenu() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  
  sidebar.classList.toggle('mobile-open');
  overlay.classList.toggle('active');
  
  // Prevent body scroll when menu is open
  if (sidebar.classList.contains('mobile-open')) {
    document.body.style.overflow = 'hidden';
  } else {
    document.body.style.overflow = '';
  }
}

function closeMobileMenu() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  
  sidebar.classList.remove('mobile-open');
  overlay.classList.remove('active');
  document.body.style.overflow = '';
}
</script>

</body>
</html>